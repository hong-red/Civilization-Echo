<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- å¼•å…¥æ€æºå®‹ä½“ï¼Œä½¿ç”¨å›½å†…é•œåƒåŠ é€Ÿ -->
<link href="https://fonts.loli.net/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
<title>ç¥å…½è¯—è¯æ•…äº‹ Â· æ–‡æ˜å›å“</title>
<style>
:root {
  --bg1: #eaf7ef;
  --bg2: #f6fff8;
  --accent: #4d6b57;
  --text: #2e3d33;
}
body {
  margin: 0;
  font-family: "Noto Serif SC", "å®‹ä½“", serif;
  background: linear-gradient(var(--bg1), var(--bg2));
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
header {
  text-align: center;
  padding: 40px 20px 20px;
}
header h1 {
  margin: 0 0 8px;
  font-size: 28px;
}
header p {
  margin: 0;
  font-size: 15px;
  color: var(--accent);
}
main {
  max-width: 760px;
  margin: auto;
  padding: 20px;
  flex: 1;
}
.box {
  background: #fff;
  border-radius: 16px;
  padding: 28px;
  margin-bottom: 24px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
  line-height: 1.8;
}
.box h3 {
  margin-top: 0;
  text-align: center;
  color: var(--accent);
  font-size: 20px;
}
.poem {
  white-space: pre-line;
  text-align: center;
  font-size: 18px;
  margin: 20px 0;
  color: #444;
}
#storyBox {
  font-size: 17px;
  min-height: 180px;
}
.button-group {
  text-align: center;
  margin: 30px 0;
}
.button-group button {
  margin: 8px;
  padding: 10px 20px;
  font-size: 15px;
  border: none;
  border-radius: 30px;
  cursor: pointer;
  background: var(--accent);
  color: white;
  transition: all 0.3s;
}
.button-group button:hover {
  opacity: 0.9;
  transform: scale(1.05);
}
.button-group button:nth-child(4) {
  background: #95a5a6;
}
footer {
  text-align: center;
  padding: 30px;
  font-size: 13px;
  color: #777;
}

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 768px) {
  header {
    padding: 30px 20px 15px;
  }
  
  header h1 {
    font-size: 24px;
  }
  
  header p {
    font-size: 14px;
  }
  
  main {
    padding: 15px;
  }
  
  .box {
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .box h3 {
    font-size: 18px;
  }
  
  .poem {
    font-size: 16px;
    margin: 15px 0;
  }
  
  #storyBox {
    font-size: 16px;
    min-height: 150px;
  }
  
  .button-group {
    margin: 25px 0;
  }
  
  .button-group button {
    margin: 6px;
    padding: 8px 16px;
    font-size: 14px;
  }
  
  footer {
    padding: 20px;
    font-size: 12px;
  }
}
</style>
</head>
<body>

<header>
  <h1 id="pageTitle">ğŸ‰ ç¥å…½çš„è¯—æ•…äº‹</h1>
  <p id="pageSub">å¬ç¥å…½ç”¨æ¸©æŸ”çš„å£°éŸ³è®²ç»™ä½ å¬</p>
</header>

<main>
  <div class="box" id="storyBox">
    ğŸŒ¿ ç¥å…½æ­£åœ¨è½»è½»ç¿»å¼€å¤è€çš„ä¹¦é¡µâ€¦â€¦
  </div>

  <div class="box">
    <h3 id="poemTitle">æ˜¥æ™“ Â· å­Ÿæµ©ç„¶</h3>
    <div class="poem" id="poemText"></div>
  </div>

  <div class="button-group">
    <button onclick="playStory()">ğŸ”Š æ’­æ”¾æ•…äº‹</button>
    <button onclick="pauseStory()">â¸ æš‚åœ</button>
    <button onclick="reloadStory()">ğŸ”„ å†è®²ä¸€éï¼ˆæ–°æ•…äº‹ï¼‰</button>
    <button onclick="location.href='kid.html'">ğŸ  è¿”å›ç¥å…½å›­</button>
  </div>
</main>

<footer>
  æ–‡æ˜å›å“ Â· æ¯ä¸€æ¬¡æ•…äº‹ï¼Œéƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ç›¸é‡
</footer>

<script>
const THEMES = {
  é’é¾™: { bg1: "#e6f5ef", bg2: "#f6fff9", accent: "#3b7f6b" },
  ç™½è™: { bg1: "#f8f8f8", bg2: "#ffffff", accent: "#555555" },
  æœ±é›€: { bg1: "#fff0ea", bg2: "#fff8f3", accent: "#e74c3c" },
  ç„æ­¦: { bg1: "#eef2f7", bg2: "#f9fbff", accent: "#34495e" }
};

function get(name, fallback = "") {
  const v = new URLSearchParams(location.search).get(name);
  return v ? decodeURIComponent(v) : fallback;
}

let utterance = null;
let currentStory = "";

async function generateStory() {
  const beast = get("beast", "é’é¾™");
  const title = get("title", "æ˜¥æ™“");
  const poet = get("poet", "å­Ÿæµ©ç„¶");
  const text = get("text", "æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚\nå¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚");

  // åº”ç”¨ä¸»é¢˜
  const theme = THEMES[beast] || THEMES["é’é¾™"];
  document.documentElement.style.setProperty("--bg1", theme.bg1);
  document.documentElement.style.setProperty("--bg2", theme.bg2);
  document.documentElement.style.setProperty("--accent", theme.accent);

  // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œè¯—
  document.getElementById("pageTitle").innerText = `${beast} çš„è¯—æ•…äº‹`;
  document.getElementById("poemTitle").innerText = `${title} Â· ${poet}`;
  document.getElementById("poemText").innerText = text;

  const storyBox = document.getElementById("storyBox");
  storyBox.innerHTML = `<em>ğŸŒ¿ ${beast}æ­£åœ¨ä¸ºä½ ç¼–ç»‡æ•…äº‹...<br>(AI åˆ›ä½œä¸­ï¼Œå¤§çº¦éœ€è¦ 10 ç§’)</em>`;

  // è‡ªåŠ¨è¶…æ—¶å¤„ç†
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’å‰ç«¯è¶…æ—¶

  try {
    // æ™ºèƒ½ API åŸºç¡€ URLï¼šæœ¬åœ°ç”¨ localhostï¼Œçº¿ä¸Šç”¨ Vercel
    const API_BASE_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
      ? "http://localhost:3000"
      : "https://civilization-echo.vercel.app";
    
    const response = await fetch(`${API_BASE_URL}/api/kids/story`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        beast: beast,
        poemTitle: title,
        poet: poet,
        poemText: text
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");

    const data = await response.json();
    currentStory = data.story || "ç¥å…½èµ°è¿›äº‘é›¾é‡Œäº†ï¼Œä¸€ä¼šå„¿å†æ¥å§ã€‚";

    storyBox.innerHTML = currentStory.replace(/\n/g, "<br>");

    // å‡†å¤‡è¯­éŸ³åˆæˆ
    utterance = new SpeechSynthesisUtterance(currentStory);
    utterance.lang = "zh-CN";
    utterance.rate = 0.85;  // ç¨æ…¢ï¼Œæ›´æ¸©æŸ”
    utterance.pitch = 1.1;

  } catch (err) {
    clearTimeout(timeoutId);
    console.error(err);
    storyBox.innerHTML = `
      <em>ğŸŒ« äº‘é›¾å¤ªé‡ï¼Œ${beast}çš„å£°éŸ³æš‚æ—¶ä¼ ä¸è¿‡æ¥...</em><br>
      <button onclick="generateStory()" style="margin-top:15px; padding:8px 20px; background:#e67e22; color:white; border:none; border-radius:20px; cursor:pointer;">
        å†è¯·ç¥å…½è®²ä¸€é
      </button>
    `;
  }
}

function playStory() {
  if (utterance && currentStory) {
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
  }
}

function pauseStory() {
  window.speechSynthesis.cancel();
}

function reloadStory() {
  generateStory();  // é‡æ–°è°ƒç”¨ APIï¼Œç”Ÿæˆå…¨æ–°æ•…äº‹
}

// é¡µé¢åŠ è½½æ—¶ç”Ÿæˆæ•…äº‹
generateStory();
</script>

</body>
</html>